<script type="text/html" data-template-name="ai-response">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-apiKey"><i class="fa fa-key"></i> API Key</label>
        <input type="password" id="node-input-apiKey" placeholder="Your Gemini API Key">
    </div>
    <div class="form-row">
        <label for="node-input-model"><i class="fa fa-cogs"></i> Model</label>
        <input type="text" id="node-input-model" placeholder="gemini-pro">
    </div>
    <div class="form-row">
        <label for="node-input-maxTokens"><i class="fa fa-text-width"></i> Max. Output Tokens</label>
        <input type="number" id="node-input-maxTokens" placeholder="200" min="10">
    </div>
    <div class="form-row">
        <label for="node-input-temperature"><i class="fa fa-thermometer-half"></i> Temperature</label>
        <input type="number" id="node-input-temperature" placeholder="0.7" step="0.1" min="0" max="1">
    </div>
    <div class="form-row">
        <label for="node-input-topP"><i class="fa fa-dot-circle-o"></i> Top P</label>
        <input type="number" id="node-input-topP" placeholder="0.9" step="0.01" min="0" max="1">
    </div>
    <div class="form-row">
        <label for="node-input-topK"><i class="fa fa-sort-numeric-asc"></i> Top K</label>
        <input type="number" id="node-input-topK" placeholder="1" min="1" max="100">
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-systemPrompt"><i class="fa fa-comment"></i> System Prompt</label>
        <textarea id="node-input-systemPrompt" style="height: 100px;" placeholder="You are a helpful and friendly assistant."></textarea>
    </div>
    <div class="form-row">
        <label for="node-input-maxHistory"><i class="fa fa-history"></i> Max. History</label>
        <input type="number" id="node-input-maxHistory" placeholder="10" min="0">
    </div>

    <div class="form-tips">
        Tip: The API Key is necessary for communication with Gemini. For production environments, consider using a more secure credential storage method.
        <br/>
        <b>Note on System Prompt:</b> This node always forces Gemini to respond in English, regardless of the system prompt configured here or in <code>msg.req.body</code>. The provided prompt will be prepended with this instruction.
        <br/>
        <b>Note on Overrides:</b> Configured parameters here can be overridden by values sent in <code>msg.req.body</code>.
    </div>
</script>

<script type="text/html" data-help-name="ai-response">
    <p>A Node-RED node that interacts with <b>Google Gemini's</b> Large Language Model (LLM), managing both response generation and conversation <b>context and history</b>.</p>
    <p>It expects the user's input text in <code>msg.payload</code>. The node will automatically manage conversation history and apply the system prompt before querying Gemini.</p>
    <p><b>Important Note on Language:</b> This node is designed to <b>always force Gemini to respond in English</b>. An explicit instruction to respond in English is prepended to the system prompt before sending it to the Gemini API, overriding any language preferences you might set in the system prompt itself.</p>
    <p><b>Parameter Flexibility:</b> All configuration parameters (API Key, Model, System Prompt, etc.) can be overridden at runtime if sent in <code>msg.req.body</code>. If not specified in <code>msg.req.body</code>, the node will use the values configured in its properties, or if not configured there, internal defaults.</p>
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Name <span class="property-type">string</span></dt>
        <dd>Optional name for the node in the editor.</dd>
        <dt>API Key <span class="property-type">string</span></dt>
        <dd>Your API key for Google Gemini. <b>CAUTION! This key will be visible in the node's configuration unless a secure credential method is used.</b></dd>
        <dt>Model <span class="property-type">string</span></dt>
        <dd>The name of the Gemini model to use (e.g., <code>gemini-pro</code> or <code>gemini-2.5-flash</code>).</dd>
        <dt>Max. Output Tokens <span class="property-type">number</span></dt>
        <dd>The maximum number of tokens in the generated response.</dd>
        <dt>Temperature <span class="property-type">number</span></dt>
        <dd>Controls the randomness of the response (0.0 for less random, 1.0 for more creative).</dd>
        <dt>Top P <span class="property-type">number</span></dt>
        <dd>Parameter for nucleus sampling. Lower values lead to more deterministic responses.</dd>
        <dt>Top K <span class="property-type">number</span></dt>
        <dd>Parameter for Top-K sampling. Lower values lead to more restricted responses.</dd>
        <dt>System Prompt <span class="property-type">string</span></dt>
        <dd>Initial instructions for the LLM regarding its role, personality, or response guidelines. It will be prepended with an instruction to always respond in English.</dd>
        <dt>Max. History <span class="property-type">number</span></dt>
        <dd>The maximum number of interactions (user/assistant pairs) to remember in the conversation history for this node instance.</dd>
    </dl>
    <h3>Output</h3>
    <p>The output message (<code>msg.payload</code>) will contain a JSON object with the generated text response from Gemini in its <code>payload</code> property (e.g., <code>{"payload": "AI response text"}</code>).</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('ai-response',{
        category: 'AI',
        color: '#E0FFB5',
        defaults: {
            name: {value:""},
            apiKey: {value:"", required: true},
            model: {value:"gemini-pro", required: true}, 
            maxTokens: {value:200, validate:RED.validators.number()},
            temperature: {value:0.7, validate:RED.validators.number()},
            topP: {value:0.9, validate:RED.validators.number()},
            topK: {value:1, validate:RED.validators.number()},
            systemPrompt: {value:"You are a helpful and friendly assistant.", required: true},
            maxHistory: {value:10, validate:RED.validators.number()}
        },
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-comments",
        label: function() {
            return this.name||"AI Response (Gemini)";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        }
    });
</script>